<project name="didactor-config" default="config" basedir=".">
     <!-- We need the 'foreach' and 'if' tasks, therefore we use ant-contrib -->
     <taskdef resource="net/sf/antcontrib/antcontrib.properties">
       <classpath>
         <pathelement location="lib/ant-contrib-1.0b1.jar"/>
       </classpath>
     </taskdef>

  <echo message="configuring..."/>
   <!--
       my.properties is supposed to be a symlink or copy of the actual
       property file to be used by default.

       note that any properties set here will override any properties set
       in build.properties and configure.properties.

       if you need to override this one, use the -propertyfile option to
       ant
    -->

  <property file="my.properties"/>
  <property file="build.properties"/>
  <property file="configure.properties"/>
  <property name="build.config.dir" value="${build.dir}/webapp/WEB-INF/config" />
  <property name="build.wizards.dir" value="${build.dir}/webapp/editwizards" />

  <target name="config" description="Configure the didactor instance with the values from the properties file">
    <tstamp>
        <format property="war.time" pattern="hh:mm aa, dd MMMM yyyy" locale="en"/>
    </tstamp>
    <replace file="${build.dir}/webapp/version.jsp"
             token="$${war.name}"
             value="${war.name}"/>
    <replace file="${build.dir}/webapp/version.jsp"
             token="$${components}"
             value="${components}"/>
    <replace file="${build.dir}/webapp/version.jsp"
             token="$${war.time}"
             value="${war.time}"/>

    <replace file="${build.config.dir}/log/log4j.xml"
             token="$${mmbase.logdir}"
             value="${mmbase.logdir}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.password}"
             value="${jdbc.password}"/>
    <replace file="${build.config.dir}//modules/jdbc.xml"
             token="$${jdbc.port}"
             value="${jdbc.port}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.supportclass}"
             value="${jdbc.supportclass}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.database}"
             value="${jdbc.database}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.user}"
             value="${jdbc.user}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.connections}"
             value="${jdbc.connections}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.driver}"
             value="${jdbc.driver}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.host}"
             value="${jdbc.host}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.url}"
             value="${jdbc.url}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.querys}"
             value="${jdbc.querys}"/>
    <replace file="${build.config.dir}/modules/jdbc.xml"
             token="$${jdbc.probetime}"
             value="${jdbc.probetime}"/>
    <replace file="${build.config.dir}/modules/mmbaseroot.xml"
             token="$${mmbaseroot.machinename}"
             value="${mmbaseroot.machinename}"/>
    <replace file="${build.config.dir}/modules/mmbaseroot.xml"
             token="$${mmbaseroot.host}"
             value="${mmbaseroot.host}"/>
    <replace file="${build.config.dir}/modules/mmbaseroot.xml"
             token="$${mmbaseroot.database}"
             value="${mmbaseroot.database}"/>
    <replace file="${build.config.dir}/modules/mmbaseroot.xml"
             token="$${mmbaseroot.basename}"
             value="${mmbaseroot.basename}"/>
    <replace file="${build.config.dir}/modules/mmbaseroot.xml"
             token="$${mmbaseroot.multicasthost}"
             value="${mmbaseroot.multicasthost}"/>
    <replace file="${build.config.dir}/modules/mmbaseroot.xml"
             token="$${mmbaseroot.multicastport}"
             value="${mmbaseroot.multicastport}"/>
    <replace file="${build.config.dir}/applications/Resources/builders/images.xml"
             token="$${imageconvert.converterroot}"
             value="${imageconvert.converterroot}"/>
    <replace file="${build.config.dir}/applications/Resources/builders/images.xml"
             token="$${imageconvert.convertercommand}"
             value="${imageconvert.convertercommand}"/>

    <replace file="${build.dir}/webapp/WEB-INF/classes/cloudprovider.properties"
             token="$${cloudprovider.adminpassword}"
             value="${cloudprovider.adminpassword}"/>

    <if>
      <available file="${build.config.dir}/modules/sendmail.xml" />
      <then>
        <replace file="${build.config.dir}/modules/sendmail.xml"
                 token="$${sendmail.smarthost}"
                 value="${sendmail.smarthost}"/>
      </then>
    </if>
    <if>
      <available file="${build.config.dir}/modules/smtpmodule.xml" />
      <then>
        <replace file="${build.config.dir}/modules/smtpmodule.xml"
                 token="$${smtpmodule.hostname}"
                 value="${smtpmodule.hostname}"/>
        <replace file="${build.config.dir}/modules/smtpmodule.xml"
                 token="$${smtpmodule.port}"
                 value="${smtpmodule.port}"/>
        <replace file="${build.config.dir}/modules/smtpmodule.xml"
                 token="$${smtpmodule.relaydomains}"
                 value="${smtpmodule.relaydomains}"/>
      </then>
    </if>

    <if>
      <available file="${build.config.dir}/chat/chat.properties" />
      <then>
        <replace file="${build.config.dir}/chat/chat.properties"
                 token="$${chat.server.logfile}"
                 value="${chat.server.logfile}"/>
        <replace file="${build.config.dir}/chat/chat.properties"
                 token="$${chat.engine.logfile}"
                 value="${chat.engine.logfile}"/>
      </then>
    </if>

    <replace dir="${build.wizards.dir}/data/config"
             token="$${wizards.pages.text.ftype}"
             value="${wizards.pages.text.ftype}"
             summary="true"
             includes="**/*.xml"
    />


    <if>
      <available file="${build.dir}/webapp/register/index.jsp" />
      <then>
        <replace file="${build.dir}/webapp/register/index.jsp"
                 token="$${cloudprovider.adminpassword}"
                 value="${cloudprovider.adminpassword}"/>
      </then>
    </if>


  </target>
</project>
